@model DoAnWebThiTracNghiem.ViewModel.GenerateQuestionRequest
@{
    ViewData["Title"] = "CreateWithAI";
    Layout = "~/Areas/Teacher/Views/Shared/_layout.cshtml";
    var subject = (List<DoAnWebThiTracNghiem.Models.Subject>)ViewData["Subjects"];
    var level = (List<DoAnWebThiTracNghiem.Models.Level>)ViewData["Levels"];
    var questiont = (List<DoAnWebThiTracNghiem.Models.QuestionType>)ViewData["QuestionTypes"];
}


<h2 class="mb-6 text-2xl font-bold text-gray-800">Tạo câu hỏi với AI</h2>

<div class="container mx-auto p-4">
    <div class="rounded-lg bg-gray-100 p-6 shadow-md">
        <button id="btnGenerateWithAI" data-controller="question" data-action="generatewithai" class="rounded-lg bg-blue-500 px-4 py-2 text-white transition hover:bg-blue-600">
            Tạo với AI
        </button>

        <div id="aiForm" class="mt-6 hidden">
            <form id="generateQuestionsForm" class="space-y-4">
                <div>
                    <label for="numberOfQuestions" class="block text-sm font-medium text-gray-700">Số câu hỏi</label>
                    <input type="number" id="numberOfQuestions" name="numberOfQuestions" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" min="1" required>
                </div>
                <div>
                    <label for="subjectId" class="block text-sm font-medium text-gray-700">Môn học</label>
                    <select id="subjectId" name="subjectId" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        <option value="">-- Chọn môn học --</option>
                        @foreach (var subject in subject)
                        {
                            <option value="@subject.Subject_Id">@subject.Subject_Name</option>
                        }
                    </select>
                </div>
                <div>
                    <label for="levelId" class="block text-sm font-medium text-gray-700">Độ khó</label>
                    <select id="levelId" name="levelId" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        <option value="">-- Chọn độ khó --</option>
                        @foreach (var level in level)
                        {
                            <option value="@level.Id">@level.LevelName</option>
                        }
                    </select>
                </div>
                <div>
                    <label for="questionTypeId" class="block text-sm font-medium text-gray-700">Loại câu hỏi</label>
                    <select id="questionTypeId" name="questionTypeId" class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        <option value="">-- Chọn loại câu hỏi --</option>
                        @foreach (var questionType in questiont)
                        {
                            <option value="@questionType.Id">@questionType.Name</option>
                        }
                    </select>
                </div>
                <button type="button" id="generateQuestions" class="w-full rounded-lg bg-green-500 px-4 py-2 text-white transition hover:bg-green-600">
                    Tạo câu hỏi
                </button>
            </form>
        </div>

        <div id="generatedQuestions" class="mt-6">
            <!-- Hiển thị danh sách câu hỏi được tạo -->
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Sự kiện mở form AI
            $("#btnGenerateWithAI").on("click", function () {
                $("#aiForm").toggleClass("hidden");
            });

            // Sự kiện tạo câu hỏi với AI
            $("#generateQuestions").on("click", function () {
                const form = $("#generateQuestionsForm")[0];
                const formData = new FormData(form);

                // Chuyển đổi dữ liệu thành đối tượng với kiểu số nguyên
                const requestData = {
                    numberOfQuestions: parseInt(formData.get('numberOfQuestions')) || 0,
                    subjectId: parseInt(formData.get('subjectId')) || 0,
                    levelId: parseInt(formData.get('levelId')) || 0,
                    questionTypeId: parseInt(formData.get('questionTypeId')) || 0
                };

                // Kiểm tra dữ liệu đầu vào
                if (requestData.numberOfQuestions <= 0) {
                    $("#generatedQuestions").html('<p class="text-red-500">Vui lòng nhập số câu hỏi lớn hơn 0.</p>');
                    return;
                }
                if (requestData.subjectId <= 0) {
                    $("#generatedQuestions").html('<p class="text-red-500">Vui lòng chọn môn học hợp lệ.</p>');
                    return;
                }
                if (requestData.levelId <= 0) {
                    $("#generatedQuestions").html('<p class="text-red-500">Vui lòng chọn độ khó hợp lệ.</p>');
                    return;
                }
                if (requestData.questionTypeId <= 0) {
                    $("#generatedQuestions").html('<p class="text-red-500">Vui lòng chọn loại câu hỏi hợp lệ.</p>');
                    return;
                }

                console.log('Request Data:', requestData);

                $.ajax({
                    url: "/Teacher/Question/GenerateWithAI",
                    type: "POST",
                    data: JSON.stringify(requestData),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        console.log('Response Data:', data);

                        let questionsToDisplay = [];
                        if (data.questionContent && data.options) {
                            questionsToDisplay = [data];
                        } else if (Array.isArray(data)) {
                            questionsToDisplay = data;
                        } else if (data.questions && Array.isArray(data.questions)) {
                            questionsToDisplay = data.questions;
                        }

                        if (questionsToDisplay.length > 0) {
                            let html = '';
                            questionsToDisplay.forEach((q, index) => {
                                console.log('Processing question:', q);
                                const optionsHtml = q.options && Array.isArray(q.options) && q.options.length > 0
                                    ? q.options.map((opt, i) => `<p>${String.fromCharCode(65 + i)}: ${opt}</p>`).join('')
                                    : '<p class="text-yellow-500">Không có đáp án nào.</p>';

                                html += `
                                    <div class="mb-4 rounded-lg bg-white p-4 shadow-md">
                                        <h3 class="text-lg font-semibold text-gray-800">Câu hỏi ${index + 1}: ${q.questionContent || 'Không có nội dung câu hỏi'}</h3>
                                        <div class="mt-2"><strong>Đáp án:</strong><br>${optionsHtml}</div>
                                        <p class="mt-2 font-semibold text-green-600">Đáp án đúng: ${q.correctOption || 'Không có đáp án'}</p>
                                    </div>
                                `;
                            });
                            $("#generatedQuestions").html(html);
                        } else if (data && data.error) {
                            $("#generatedQuestions").html(`<p class="text-red-500">Lỗi từ server: ${data.error}</p>`);
                        } else {
                            $("#generatedQuestions").html('<p class="text-red-500">Không có câu hỏi nào được tạo. Có thể dữ liệu đầu vào không hợp lệ hoặc server không thể tạo câu hỏi.</p>');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', error);
                        $("#generatedQuestions").html(`<p class="text-red-500">Đã xảy ra lỗi khi tạo câu hỏi: ${error}</p>`);
                    }
                });
            });
        });
    </script>
}